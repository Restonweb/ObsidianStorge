# Active Directory basic
## 域
AD是Microsoft对于企业用户计算机集中管理的解决方案
对于大量的服务器以及计算机集，AD使用Windows域来定义他们，其中，运行AD服务的服务器被称为DC（Domain Controller）域控制器
域的优点是可以统筹管理所有用户的身份，以及轻松的管理Windows安全策略
## AD服务
AD支持许多对象，其中包括：
### 用户
用户是最常见的对象类型，其是安全主体的对象之一，意味着他们可以通过域进行身份验证以及分配对文件或打印机等资源的权限。
安全主体就是对网络中资源执行操作的对象
用户可用于表示两种类型的实体：
人员：用户通常代表需要访问网络的人员，比如员工。
服务：其还可以定义IIS或MSSQL等服务要使用的用户，每个服务都需要一个用户才能运行，他们与普通用户的区别是其只拥有对特定服务所需的权限。
### 机器
计算机也是AD中的一种对象，对于加入AD域的每一台计算机，将创建一个计算机对象，其也被视为是一种安全主体，并像普通用户一样被分配一个账户，这个账户在域中的权限有限。
但对于本地来说，计算机账户是本地管理员，其密码通常由120位随机字符组成，并会定期自动轮换
识别计算机账户比较容易，其通常带有$后缀
### 安全组
Windows可以定义用户组，以便将对文件或其他资源的访问权限分配给整个组，而不是单个用户。这样可以提高可管理性，我们可以将用户添加到现有组，并且他们将自动继承该组的所有权限。安全组也被视为安全主体，因此可以对网络上的资源具有权限。
组可以同时将用户和计算机作为成员。如果需要，组也可以包括其他组。
默认情况下，域会创建多个组，下面是重要的一些组：
域管理员：此组的用户对整个域具有管理权限。默认情况下，他们可以管理域上的任何计算机，包括 DC。
服务器操作员：此组中的用户可以管理域控制器。他们无法更改任何管理组成员身份。
备份操作员：允许此组中的用户访问任何文件，而忽略其权限。它们用于在计算机上执行数据备份。
账户运营商：此组中的用户可以在域中创建或修改其他帐户。
域用户：包括域中的所有现有用户帐户。
域计算机：包括域中的所有现有计算机。
域控制器：包括域上的所有现有 DC。
AD的用户与计算机：打开windows的AD管理软件，会看到域中的用户、计算机、组是有特定的层次结构的，这些对象按组织单位（OU）进行组织。组织单位是允许您对用户和计算机进行分类的容器对象。OU主要用于定义具有相似监管要求的用户集。例如，组织销售部门的人员可能应用了与 IT 人员不同的策略集。请记住，用户一次只能是单个 OU 的一部分。
除了OU之外，还有其他默认容器。这些容器由 Windows 自动创建，并包含以下内容：
内置：包含可用于任何 Windows 主机的默认组。
计算机：默认情况下，任何加入网络的机器都将被放在这里。如果需要，您可以移动它们。
域控制器：包含网络中 DC 的默认 OU。
用户：适用于域范围上下文的默认用户和组。
托管服务帐户：保存 Windows 域中服务使用的帐户。
## 在AD中管理用户与计算机
用户权限委派（Delegation）：
在 AD 中，可以让特定用户对某些 OU 进行一些控制。此过程称为委派，允许管理员授予普通用户在 OU 上执行高级任务的特定权限，而无需域管理员介入。
最常见的用例之一是授予重置其他低权限用户密码的权限。
对于计算机，通常被分为三个类别:
1. 工作站
工作站是 Active Directory 域中最常见的设备之一。域中的每个用户都可能登录到工作站。这是他们用来完成工作或正常浏览活动的设备。这些设备不应有特权用户登录到它们。
2. 服务器
服务器是 Active Directory 域中第二常见的设备。服务器通常用于向用户或其他服务器提供服务。
3. 域控制器
域控制器是 Active Directory 域中第三大最常见的设备。域控制器允许您管理 Active Directory 域。这些设备通常被认为是网络中最敏感的设备，因为它们包含环境中所有用户帐户的哈希密码
## 组策略
### GPO
上述所有的目的都是为了组织OU中的用户与计算机，背后的主题思想是为每个OU单独设定不同的策略
Windows通过组策略对象(GPO)管理此类策略
GPO是以 链接 的方式应用到OU的。链接到某OU的GPO将应用于它以及其所拥有的所有子OU。
GPO还可以应用 安全筛选 选项，以使他们仅应用于OU下的特定用户，计算机。默认情况下，将应用于经过身份验证的用户组。
### GPO的分发
GPO 通过存储在 DC 中的名为 的网络共享分发到网络。域中的所有用户通常都应有权通过网络访问此共享，以定期同步其 GPO。默认情况下，SYSVOL 共享指向我们网络中每个 DC 上的目录。SYSVOL :`C:\Windows\SYSVOL\sysvol\`

对任何 GPO 进行更改后，计算机可能需要长达 2 小时才能赶上进度。如果要强制任何特定计算机立即同步其 GPO，则始终可以在所需的计算机上运行以下命令：
`PS C:\> gpupdate /force`
## 域中的身份验证方法
使用 Windows 域时，所有凭据都存储在域控制器中。每当用户尝试使用域凭据对服务进行身份验证时，该服务都需要要求域控制器验证它们是否正确。两种协议可用于 Windows 域中的网络身份验证：
Kerberos：由任何最新版本的 Windows 使用。这是任何最新域中的默认协议。
NetNTLM：出于兼容性目的而保留的旧式身份验证协议。
虽然 NetNTLM 应被视为过时，但大多数网络都将启用这两种协议。
### Kerberos认证
Kerberos 身份验证是任何最新版本的 Windows 的默认身份验证协议。使用 Kerberos 登录服务的用户将获得票证。将票证视为先前身份验证的证明。拥有票证的用户可以将其提供给服务，以证明他们之前已经对网络进行了身份验证，因此可以使用它。

使用 Kerberos 进行身份验证时，将发生以下过程：

1.用户将其用户名和使用从其密码派生的密钥加密的时间戳发送到密钥分发中心 （KDC），该服务通常安装在负责在网络上创建 Kerberos 票证的域控制器上。
KDC 将创建并发回票证授予票证 （TGT），这将允许用户请求其他票证以访问特定服务。需要票证来获取更多票证可能听起来有点奇怪，但它允许用户在每次想要连接到服务时都无需传递其凭据即可请求服务票证。与 TGT 一起，向用户提供会话密钥，用户需要该密钥来生成以下请求。
请注意，TGT 是使用 krbtgt 帐户的密码哈希加密的，因此用户无法访问其内容。必须知道，加密的 TGT 包含会话密钥的副本作为其内容的一部分，并且 KDC 无需存储会话密钥，因为它可以在需要时通过解密 TGT 来恢复副本。
![[Screenshot_2024-03-18-21-18-10-161-edit_com.microsoft.emmx.jpg]]
2.当用户想要连接到网络上的服务（如共享、网站或数据库）时，他们将使用其 TGT 向 KDC 请求票证授予服务 （TGS）。TGS 是仅允许连接到为其创建的特定服务的票证。若要请求 TGS，用户将发送其用户名和使用会话密钥加密的时间戳，以及 TGT 和服务主体名称 （SPN），该名称指示我们打算访问的服务和服务器名称。
因此，KDC 将向我们发送一个 TGS 和一个服务会话密钥，我们需要该密钥对我们想要访问的服务进行身份验证。TGS 使用从服务所有者哈希派生的密钥进行加密。服务所有者是运行服务的用户或计算机帐户。TGS 在其加密内容上包含服务会话密钥的副本，以便服务所有者可以通过解密 TGS 来访问它。
![[Screenshot_2024-03-18-21-19-41-941-edit_com.microsoft.emmx.jpg]]
3.然后，可以将 TGS 发送到所需的服务以进行身份验证并建立连接。该服务将使用其配置的帐户的密码哈希来解密 TGS 并验证服务会话密钥。
![[Screenshot_2024-03-18-21-20-18-980-edit_com.microsoft.emmx.jpg]]
### NetNTLM身份验证
NetNTLM 使用质询-响应机制工作。整个过程如下：
![[Screenshot_2024-03-18-21-20-50-936-edit_com.microsoft.emmx.jpg]]
1.客户端向要访问的服务器发送身份验证请求。
2.服务器生成一个随机数，并将其作为质询发送给客户端。
3.客户端将其 NTLM 密码哈希与质询（和其他已知数据）相结合，以生成对质询的响应，并将其发送回服务器进行验证。
4.服务器将质询和响应转发给域控制器进行验证。
5.域控制器使用质询来重新计算响应，并将其与客户端发送的原始响应进行比较。如果两者都匹配，则客户端已通过身份验证;否则，访问将被拒绝。身份验证结果将发送回服务器。
6.服务器将认证结果转发给客户端。
请注意，为了安全起见，用户的密码（或哈希值）绝不会通过网络传输。

注意：所述过程适用于使用域帐户的情况。如果使用本地帐户，则服务器可以验证对质询本身的响应，而无需与域控制器交互，因为它的密码哈希存储在其本地 SAM 上。

## 树Tree,林Forest,信任Trust
随着公司的发展，他们的网络也在发展。为一家公司拥有一个域名就足够了，但随着时间的推移，一些额外的需求可能会促使其拥有多个域名。
### 树Tree
想象一下，您的公司突然扩展到一个新的国家。新国家/地区有不同的法律和法规，要求您更新 GPO 以符合要求。此外，您现在在两个国家/地区都有 IT 人员，每个 IT 团队都需要在不干扰另一个团队的情况下管理与每个国家/地区相对应的资源。虽然您可以创建复杂的 OU 结构并使用委派来实现此目的，但拥有庞大的 AD 结构可能难以管理并且容易出现人为错误。

幸运的是，Active Directory 支持集成多个域，以便将网络划分为可以独立管理的单元。如果有两个域共享相同的命名空间，则可以将这些域加入到树中。

如果我们的域被拆分为英国和美国分支的两个子域，您可以构建一个根域为 的树，以及两个名为 和 的子域，每个子域都有其 AD、计算机和用户：thm.local uk.thm.local us.thm.local
![[Screenshot_2024-03-18-21-28-23-063-edit_com.microsoft.emmx.jpg]]
这种分区结构使我们能够更好地控制谁可以访问域中的内容。来自英国的 IT 人员将拥有自己的 DC，仅管理英国资源。例如，英国用户将无法管理美国用户。这样，每个分支的域管理员将完全控制其各自的 DC，但不能控制其他分支的 DC。

在谈论树木和森林时，需要引入一个新的安全组。Enterprise Admins 组将授予用户对企业所有域的管理权限。每个域仍将具有对其单个域具有管理员权限的域管理员，以及可以控制企业中所有内容的企业管理员。

### 林Forest
管理的域也可以在不同的命名空间中进行配置。假设公司继续发展并最终收购了另一家名为“当两家公司合并时”的公司，可能要为每家公司提供不同的域树，每家公司都由自己的 IT 部门管理。将具有不同命名空间的几棵树合并到同一个网络中称为林。
![[Screenshot_2024-03-18-21-33-30-468-edit_com.microsoft.emmx.jpg]]

### 信任关系Trust
在树木和森林中组织多个域可以让您在管理和资源方面拥有一个很好的分区网络。但在某个时候，THM UK 的用户可能需要访问 MHT ASIA 服务器之一中的共享文件。为此，在树和林中排列的域通过信任关系连接在一起。
简单来说，在域之间建立信任关系允许您授权域中的用户访问域中的资源。
可以建立的最简单的信任关系是单向信任关系。在单向信任中，如果信任，这意味着 BBB 上的用户可以被授权访问 AAA 上的资源：
![[Screenshot_2024-03-18-21-34-45-826-edit_com.microsoft.emmx.jpg]]
单向信任关系的方向与访问方向的方向相反。

还可以建立双向信任关系，以允许两个域相互授权来自另一个域的用户。默认情况下，在树或林下加入多个域将形成双向信任关系。

请务必注意，在域之间建立信任关系不会自动授予对其他域上所有资源的访问权限。建立信任关系后，您就有机会对不同域的用户进行授权，但实际授权与否取决于您。

# Breaching Active Directory
## 开始破坏AD
在利用 AD 错误配置进行权限提升、横向移动和目标执行之前，您需要先进行**初始访问**。您需要获取**一组初始**有效的 AD 凭据。由于 AD 服务和功能的数量，获取一组初始 AD 凭据的攻击面通常很大。
在查找第一组凭据时，我们不关注与帐户关联的权限;因此，即使是低特权帐户也足够了。我们只是在寻找一种向 AD 进行身份验证的方法，允许我们对 AD 本身进行进一步的枚举。
***获取初始凭证是接下来所有行动的目的。***
## OSINT和网络钓鱼
### OSINT
OSINT，即OpenSourceInTellgence(开源情报)用于发现已公开的相关目标信息。
而与AD凭据相关的：
- 在公共论坛（如 Stack Overflow）上提问但在问题中披露敏感信息（例如其凭据）的用户。
- 使用硬编码凭据将脚本上传到 Github 等服务的开发人员。
- 由于员工使用其工作帐户注册其他外部网站，因此在过去违规行为中披露了凭据。HaveIBeenPwned 和 DeHashed 等网站提供了极好的平台来确定某人的信息（例如工作电子邮件）是否曾经涉及公开的数据泄露。
通过使用 OSINT 技术，可以发现公开披露的凭据。如果我们有幸找到凭据，我们仍然需要找到一种方法来测试它们是否有效，因为 OSINT 信息可能已经过时。
### 网络钓鱼
网络钓鱼是破坏 AD 的另一种极好方法。 网络钓鱼通常诱使用户在恶意网页上提供其凭据，或要求他们运行将在后台安装远程访问木马 （RAT） 的特定应用程序。这是一种普遍的方法，因为 RAT 将在用户的上下文中执行，立即允许您模拟该用户的 AD 帐户。
## NTLM身份验证服务
### NTLM和NetNTLM
New Technology LAN Manager (NTLM)是一套安全协议，用于在 AD 中对用户的身份进行身份验证。网络上的服务大量使用此身份验证机制。但是，使用 NetNTLM 的服务也可以向 Internet 公开。以下是一些流行的例子：
- 公开 Outlook Web App （OWA） 登录门户的内部承载的 Exchange （邮件） 服务器。
- 向 Internet 公开的服务器的远程桌面协议 （RDP） 服务。
- 公开了与 AD 集成的 VPN 终结点。
- 面向 Internet 并使用 NetNTLM 的 Web 应用程序。
这意味着应用程序代表用户进行身份验证，而不是直接在应用程序本身上对用户进行身份验证。这样可以防止应用程序存储 AD 凭据，这些凭据应仅存储在域控制器上。此过程如下图所示：
![[Pasted image 20240319212509.png]]
### 暴力登录攻击
这些公开的服务为测试使用其他方式发现的凭据提供了绝佳的位置。但是，这些服务也可以直接用于尝试恢复一组初始有效的 AD 凭据。如果我们在最初的红队侦察期间恢复了有效的电子邮件地址等信息，我们也许可以尝试使用这些进行暴力攻击。
由于大多数 AD 环境都配置了帐户锁定，因此我们无法运行完整的暴力攻击。相反，我们需要执行密码喷射攻击。我们选择并使用一个密码（如某些服务初始部署后的初始密码未被用户更改），并尝试使用我们获得的所有用户名进行身份验证，而不是尝试多个可能触发帐户锁定机制的不同密码。但是，应该注意的是，由于这些类型的攻击将生成失败的身份验证尝试数量，因此可以检测到这些类型的攻击。我们可以使用 Hydra 等工具来协助密码喷射攻击。
## LADP绑定凭据
### LDAP协议
应用程序可以使用的另一种 AD 身份验证方法是轻量级目录访问协议 （LDAP） 身份验证。LDAP 身份验证类似于 NTLM 身份验证。但是，使用 LDAP 身份验证时，应用程序会直接验证用户的凭据。应用程序具有一对 AD 凭据，可以首先使用它们来查询 LDAP，然后验证 AD 用户的凭据。
LDAP 身份验证是与 AD 集成的第三方（非 Microsoft）应用程序的常用机制。这些包括应用程序和系统，例如：
- Gitlab
- Jenkins
- 定制开发的 Web 应用程序
- 打印机
- VPNs
如果这些应用程序或服务中的任何一个在 Internet 上公开，则可以使用与针对 NTLM 身份验证系统的攻击类型相同的攻击。但是，由于使用 LDAP 身份验证的服务需要一组 AD 凭据，因此它开辟了额外的攻击途径。从本质上讲，我们可以尝试恢复服务使用的 AD 凭据，以获得对 AD 的经过身份验证的访问。通过LDAP进行身份验证的过程如下所示：
![[Pasted image 20240319212945.png]]
如果您可以在正确的主机（例如 Gitlab 服务器）上站稳脚跟，则只需读取配置文件即可恢复这些 AD 凭据。这些凭据通常以纯文本形式存储在配置文件中，因为安全模型依赖于保持位置和存储配置文件的安全，而不是其内容。
### LDAP 回传攻击
但是，可以针对 LDAP 身份验证机制执行另一种非常有趣的攻击，称为 LDAP 回传攻击。当您获得对内部网络的初始访问权限时，这是一种针对网络设备（如打印机）的常见攻击，例如在会议室中插入恶意设备。
当我们访问指定了 LDAP 参数的设备配置时，可以执行 LDAP 回传攻击。例如，这可以是网络打印机的 Web 界面。通常，这些接口的凭据保留为默认凭据，例如 `admin:admin` 或 `admin:password` 。在这里，我们将无法直接提取LDAP凭据，因为密码通常是隐藏的。但是，我们可以更改LDAP配置，例如LDAP服务器的IP或主机名。在LDAP回传攻击中，我们可以将此IP修改为我们的IP，然后测试LDAP配置，这将强制设备尝试对我们的恶意设备进行LDAP身份验证。我们可以拦截此身份验证尝试以恢复 LDAP 凭据。
### 执行 LDAP 回传
在将设备的LDAP服务器IP改为我们的攻击机后，我们就可以进行LDAP回传攻击了。
从本质上讲，在打印机发送凭据之前，它正在尝试协商 LDAP 身份验证方法详细信息。它将使用此协商来选择打印机和 LDAP 服务器都支持的最安全的身份验证方法。如果身份验证方法过于安全，则不会以明文形式传输凭据。使用某些身份验证方法，凭据根本不会通过网络传输！因此，我们不能只使用普通的 Netcat 来获取凭据。我们需要创建一个流氓 LDAP 服务器并对其进行不安全的配置，以确保凭据以明文形式发送。
#### 托管恶意LDAP服务器
有几种方法可以托管恶意 LDAP 服务器，我们将使用 OpenLDAP。
使用以下命令安装 OpenLDAP：
```bash
sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd
```
在初始配置时，对于 DNS 域名，提供我们的目标域名,确保对组织名称也使用相同的名称，设置密码，选择MDB作为LDAP数据库
在使用流氓LDAP服务器之前，我们需要通过降级支持的身份验证机制来使其容易受到攻击。我们希望确保我们的 LDAP 服务器仅支持 PLAIN 和 LOGIN 身份验证方法。为此，我们需要创建一个新的 ldif 文件，该文件使用以下内容调用：
```
#olcSaslSecProps.ldif dn: cn=config replace: olcSaslSecProps olcSaslSecProps: noanonymous,minssf=0,passcred
```
该文件具有以下属性：
- olcSaslSecProps：指定 SASL 安全属性
- noanonymous：禁用支持匿名登录的机制
- minssf：指定可接受的最小安全强度，为 0，表示无保护。
```bash
sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart
```
我们可以使用以下命令验证我们的流氓LDAP服务器的配置是否已应用（注意：如果使用的是Kali，则可能不会收到任何输出，但是该配置应该已经工作，可以继续执行后续步骤）：
```bash
Camllia@kali$ ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms 
dn: supportedSASLMechanisms: PLAIN supportedSASLMechanisms: LOGIN
```
#### 捕获LDAP凭证
我们的流氓 LDAP 服务器现已配置完毕。当设备向我们发送LDAP请求时，身份验证将以明文形式进行。如果正确配置了恶意 LDAP 服务器，并且它正在降级通信，您将收到以下错误：“This distinguished name contains invalid syntax”。如果收到此错误，可以使用 tcpdump 通过以下命令捕获凭据：
```bash
[Redcamellia@kali]$ sudo tcpdump -SX -i {attacker IP} tcp port 389
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode listening on eth1, link-type EN10MB (Ethernet), snapshot length 262144 bytes 10:41:52.979933 IP 10.10.10.201.49834 > 10.10.10.57.ldap: Flags [P.], seq 4245946075:4245946151, ack 1113052386, win 8212, length 76 0x0000: 4500 0074 b08c 4000 8006 20e2 0a0a 0ac9 E..t..@......... 0x0010: 0a0a 0a39 c2aa 0185 fd13 fedb 4257 d4e2 ...9........BW.. 0x0020: 5018 2014 1382 0000 3084 0000 0046 0201 P.......0....F.. 0x0030: 0263 8400 0000 3d04 000a 0100 0a01 0002 .c....=......... 0x0040: 0100 0201 7801 0100 870b 6f62 6a65 6374 ....x.....object 0x0050: 636c 6173 7330 8400 0000 1904 1773 7570 class0.......sup 0x0060: 706f 7274 6564 5341 534c 4d65 6368 616e portedSASLMechan 0x0070: 6973 6d73 isms 10:41:52.979938 IP 10.10.10.57.ldap > 10.10.10.201.49834: Flags [.], ack 4245946151, win 502, length 0 0x0000: 4500 0028 247d 4000 4006 ed3d 0a0a 0a39 E..($}@.@..=...9 0x0010: 0a0a 0ac9 0185 c2aa 4257 d4e2 fd13 ff27 ........BW.....' 0x0020: 5010 01f6 2930 0000 P...)0.. 10:41:52.980162 IP 10.10.10.57.ldap > 10.10.10.201.49834: Flags [P.], seq 1113052386:1113052440, ack 4245946151, win 502, length 54 0x0000: 4500 005e 247e 4000 4006 ed06 0a0a 0a39 E..^$~@.@......9 0x0010: 0a0a 0ac9 0185 c2aa 4257 d4e2 fd13 ff27 ........BW.....' 0x0020: 5018 01f6 2966 0000 3034 0201 0264 2f04 P...)f..04...d/. 0x0030: 0030 2b30 2904 1773 7570 706f 7274 6564 .0+0)..supported 0x0040: 5341 534c 4d65 6368 616e 6973 6d73 310e SASLMechanisms1. 0x0050: 0405 504c 4149 4e04 054c 4f47 494e ..PLAIN..LOGIN [....] 10:41:52.987145 IP 10.10.10.201.49835 > 10.10.10.57.ldap: Flags [.], ack 3088612909, win 8212, length 0 0x0000: 4500 0028 b092 4000 8006 2128 0a0a 0ac9 E..(..@...!(.... 0x0010: 0a0a 0a39 c2ab 0185 8b05 d64a b818 7e2d ...9.......J..~- 0x0020: 5010 2014 0ae4 0000 0000 0000 0000 P............. 10:41:52.989165 IP 10.10.10.201.49835 > 10.10.10.57.ldap: Flags [P.], seq 2332415562:2332415627, ack 3088612909, win 8212, length 65 0x0000: 4500 0069 b093 4000 8006 20e6 0a0a 0ac9 E..i..@......... 0x0010: 0a0a 0a39 c2ab 0185 8b05 d64a b818 7e2d ...9.......J..~- 0x0020: 5018 2014 3afe 0000 3084 0000 003b 0201 P...:...0....;.. 0x0030: 0560 8400 0000 3202 0102 0418 7a61 2e74 .`....2.....za.t 0x0040: 7279 6861 636b 6d65 2e63 6f6d 5c73 7663 ryhackme.com\svc 0x0050: 4c44 4150 8013 7472 7968 6163 6b6d 656c LDAP..password11
```
请注意， `password11` 是一个示例。服务的密码将有所不同。
通过使用 LDAP 回传攻击并降级支持的身份验证机制，我们可以以明文形式拦截凭据。
## 身份验证中继
我们现在将研究针对更广泛的网络身份验证协议的攻击。在 Windows 网络中，有大量服务相互通信，允许用户使用网络提供的服务。
这些服务必须使用内置身份验证方法来验证传入连接的身份。在[[Active Directory#NTLM身份验证服务]]中，我们探讨了 Web 应用程序上使用的 NTLM 身份验证。在此节点中，我们将更深入地研究从网络的角度来看此身份验证的外观。但是，对于此节点，我们将重点介绍 SMB 使用的 NetNTLM 身份验证。
### Service Message Block(SMB)
服务器消息块 （SMB） 协议允许客户端（如工作站）与服务器（如文件共享）进行通信。在使用 Microsoft AD 的网络中，SMB 管理从网络间文件共享到远程管理的所有内容。甚至在尝试打印文档时，计算机收到的“缺纸”警报也是 SMB 协议的工作。
但是，早期版本的 SMB 协议的安全性被认为不足。发现了多个漏洞和漏洞，可用于恢复凭据，甚至在设备上执行代码。尽管其中一些漏洞在协议的较新版本中得到了解决，但由于旧系统不支持它们，组织通常不会强制使用更新的版本。我们将研究使用 SMB 进行 NetNTLM 身份验证的两种不同漏洞：
- 由于 NTLM 挑战可以被拦截，因此我们可以使用离线破解技术来恢复与 NTLM 挑战相关的密码。但是，此破解过程比直接破解 NTLM 哈希要慢得多。
- 我们可以使用我们的流氓设备来发动中间人攻击，在客户端和服务器之间中继 SMB 身份验证，这将为我们提供活动的身份验证会话和对目标服务器的访问。
### LLMNR、NBT-NS 和 WPAD与Responder
我们将稍微了解一下在使用 SMB 期间发生的身份验证。我们将使用 Responder 尝试拦截 NetNTLM 质询以破解它。网络上通常有很多这样的挑战。一些安全解决方案甚至执行整个 IP 范围的扫描，以从主机恢复信息。
Responder 允许我们通过在 NetNTLM 身份验证期间毒害响应来执行中间人攻击，诱骗客户端与您交谈，而不是他们想要连接到的实际服务器。在实际 LAN 上，响应程序将尝试毒害检测到的任何链路本地多播名称解析 （LLMNR）、NetBIOS 名称服务 （NBT-NS） 和 Web 代理自动发现 （WPAD） 请求。在大型 Windows 网络上，这些协议允许主机对同一本地网络上的所有主机执行自己的本地 DNS 解析。主机可以首先尝试通过发送 LLMNR 请求并查看是否有任何主机响应来确定他们正在寻找的主机是否位于同一本地网络上，而不是使网络资源（如 DNS 服务器）负担过重。NBT-NS 是 LLMNR 的前身协议，WPAD 请求是为了尝试为将来的 HTTP（s） 连接找到代理。
由于这些协议依赖于在本地网络上广播的请求，因此我们的恶意设备也会接收这些请求。通常，这些请求会被简单地删除，因为它们不是为我们的主机准备的。但是，响应程序将主动侦听请求并发送中毒响应，告诉请求主机我们的 IP 与请求的主机名相关联。通过毒害这些请求，Responder 试图强制客户端连接到我们的 AttackBox。在同一行中，它开始托管多个服务器，例如 SMB、HTTP、SQL 等，以捕获这些请求并强制进行身份验证。
### 拦截 NetNTLM 质询

